services:
  nginx:
    image: nginx:alpine
    container_name: lmstudio-nginx
    entrypoint: >
      sh -c "
      apk add --no-cache apache2-utils &&
      htpasswd -cb /etc/nginx/.htpasswd ${AUTH_USERNAME:-admin} ${AUTH_PASSWORD:-secure_password_123} &&
      nginx -g 'daemon off;'"
    ports:
      - "${NGINX_PORT:-8080}:80"
      - "${NGINX_SSL_PORT:-8443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - ./logs:/var/log/nginx
    environment:
      - NGINX_PROXY_CONNECT_TIMEOUT=${NGINX_PROXY_CONNECT_TIMEOUT:-90}
      - NGINX_PROXY_SEND_TIMEOUT=${NGINX_PROXY_SEND_TIMEOUT:-330}
      - NGINX_PROXY_READ_TIMEOUT=${NGINX_PROXY_READ_TIMEOUT:-330}
      - AUTH_USERNAME=${AUTH_USERNAME:-admin}
      - AUTH_PASSWORD=${AUTH_PASSWORD:-secure_password_123}
    depends_on:
      - ngrok
    networks:
      - lmstudio-network
    restart: unless-stopped

  ngrok:
    image: ngrok/ngrok:latest
    container_name: lmstudio-ngrok
    command: 
      - "http"
      - "nginx:80"
      - "--authtoken=${NGROK_AUTHTOKEN}"
      - "--region=${NGROK_REGION:-us}"
      - "--log=stdout"
    ports:
      - "4040:4040"  # ngrok web interface
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    networks:
      - lmstudio-network
    restart: unless-stopped

networks:
  lmstudio-network:
    driver: bridge
